{{template "header" .}}

<div class="app-container">
  <main class="main-content">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h2>Profile</h2>
          <p class="auth-subtitle">Manage your account settings</p>
        </div>

        <div id="error-message" class="error-message hidden"></div>

        <div class="profile-info">
          <div class="form-group">
            <label for="username">Username</label>
            <div class="input-with-icon">
              <i class="fas fa-user"></i>
              <input type="text" id="username" readonly class="readonly" />
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <div class="input-with-icon">
              <i class="fas fa-envelope"></i>
              <input type="email" id="email" readonly class="readonly" />
            </div>
          </div>
        </div>

        <form id="profile-form" class="auth-form">
          <div class="form-group">
            <label for="current-password">Current Password</label>
            <div class="input-with-icon">
              <i class="fas fa-lock"></i>
              <input
                type="password"
                id="current-password"
                name="current-password"
                placeholder="Enter your current password"
                required
              />
              <button
                type="button"
                class="password-toggle"
                aria-label="Toggle password visibility"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="new-password">New Password</label>
            <div class="input-with-icon">
              <i class="fas fa-lock"></i>
              <input
                type="password"
                id="new-password"
                name="new-password"
                placeholder="Enter new password"
                required
                minlength="6"
              />
              <button
                type="button"
                class="password-toggle"
                aria-label="Toggle password visibility"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="password-requirements">
              <small>Password must be at least 6 characters long</small>
            </div>
          </div>

          <div class="form-group">
            <label for="confirm-password">Confirm New Password</label>
            <div class="input-with-icon">
              <i class="fas fa-lock"></i>
              <input
                type="password"
                id="confirm-password"
                name="confirm-password"
                placeholder="Confirm new password"
                required
                minlength="6"
              />
              <button
                type="button"
                class="password-toggle"
                aria-label="Toggle password visibility"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>

          <button type="submit" class="auth-button" id="update-password-button">
            <i class="fas fa-key"></i>
            <span>Update Password</span>
          </button>
        </form>

        <div class="profile-actions">
          <button
            type="button"
            class="profile-button danger"
            id="delete-account-button"
          >
            <i class="fas fa-trash-alt"></i>
            <span>Delete Account</span>
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  // Load profile data
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const response = await fetch("/api/profile");
      if (!response.ok) throw new Error("Failed to load profile");

      const profile = await response.json();
      document.getElementById("username").value = profile.username;
      document.getElementById("email").value = profile.email;
    } catch (error) {
      const errorDiv = document.getElementById("error-message");
      errorDiv.textContent = error.message;
      errorDiv.classList.remove("hidden");
    }
  });

  // Update password
  document
    .getElementById("profile-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const currentPassword = document.getElementById("current-password").value;
      const newPassword = document.getElementById("new-password").value;
      const confirmPassword = document.getElementById("confirm-password").value;

      if (newPassword !== confirmPassword) {
        const errorDiv = document.getElementById("error-message");
        errorDiv.textContent = "New passwords do not match";
        errorDiv.classList.remove("hidden");
        return;
      }

      try {
        const response = await fetch("/api/profile", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
          }),
        });

        if (!response.ok) throw new Error("Failed to update password");

        const errorDiv = document.getElementById("error-message");
        errorDiv.textContent = "Password updated successfully";
        errorDiv.classList.remove("hidden");
        errorDiv.classList.add("success-message");

        document.getElementById("current-password").value = "";
        document.getElementById("new-password").value = "";
        document.getElementById("confirm-password").value = "";
      } catch (error) {
        const errorDiv = document.getElementById("error-message");
        errorDiv.textContent = error.message;
        errorDiv.classList.remove("hidden");
        errorDiv.classList.remove("success-message");
      }
    });

  // Delete account
  document
    .getElementById("delete-account-button")
    .addEventListener("click", async () => {
      if (
        confirm(
          "Are you sure you want to delete your account? This action cannot be undone."
        )
      ) {
        try {
          const response = await fetch("/api/profile", {
            method: "DELETE",
          });

          if (!response.ok) throw new Error("Failed to delete account");

          window.location.href = "/login";
        } catch (error) {
          const errorDiv = document.getElementById("error-message");
          errorDiv.textContent = error.message;
          errorDiv.classList.remove("hidden");
        }
      }
    });

  // Toggle password visibility for all password fields
  document.querySelectorAll(".password-toggle").forEach((toggle) => {
    toggle.addEventListener("click", function () {
      const passwordInput = this.parentElement.querySelector("input");
      const icon = this.querySelector("i");

      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        icon.classList.remove("fa-eye");
        icon.classList.add("fa-eye-slash");
      } else {
        passwordInput.type = "password";
        icon.classList.remove("fa-eye-slash");
        icon.classList.add("fa-eye");
      }
    });
  });
</script>

{{template "footer" .}}
